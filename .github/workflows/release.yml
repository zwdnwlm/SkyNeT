name: SkyNeT Build and Release

on:
  push:
    tags:
      - 'v*' # å½“æ¨é€æ ‡ç­¾å¦‚ v2.0.3 æ—¶è§¦å‘
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨ç‚¹å‡»è§¦å‘

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write # å¿…é¡»å¼€å¯ï¼Œå¦åˆ™æ— æ³•ä¸Šä¼ åˆ° Release

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # --- 1. ç¯å¢ƒå‡†å¤‡ ---
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true
          cache-dependency-path: backend/go.sum

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      # --- 2. ç¼–è¯‘åç«¯ (é‡ç‚¹ä¿®æ­£) ---
      - name: Build Backend
        run: |
          # è¿›å…¥åç«¯ç›®å½•
          cd backend
          
          # ç¡®ä¿ä¾èµ–åŒæ­¥ï¼ˆè§£å†³ package not in std æŠ¥é”™çš„å…³é”®ï¼‰
          go mod tidy
          
          # è·å–å½“å‰æ—¶é—´ï¼ˆæ³¨å…¥åˆ° main.go çš„ BuildTime å˜é‡ï¼‰
          BUILD_TIME=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
          
          # äº¤å‰ç¼–è¯‘ Linux AMD64 ç‰ˆæœ¬
          # ä½¿ç”¨ -ldflags æ³¨å…¥ BuildTime å¹¶å‹ç¼©ä½“ç§¯ (-s -w)
          GOOS=linux GOARCH=amd64 go build \
            -ldflags="-s -w -X 'main.BuildTime=${BUILD_TIME}'" \
            -o ../SkyNeT-linux-amd64 .
          
          cd ..

      # --- 3. ç¼–è¯‘å‰ç«¯ (å¦‚æœ‰ build è„šæœ¬) ---
      - name: Build Frontend
        run: |
          cd frontend
          npm install
          # å¦‚æœä½ çš„å‰ç«¯æœ‰æ„å»ºè„šæœ¬ï¼Œè¯·å–æ¶ˆä¸‹é¢ä¸€è¡Œçš„æ³¨é‡Š
          # npm run build --if-present
          cd ..

      # --- 4. ç›®å½•åˆå§‹åŒ–éªŒè¯ ---
      - name: Prepare Package
        run: |
          # åˆ›å»ºå¿…è¦çš„è¿è¡Œç›®å½•ï¼ˆç¡®ä¿æ‰“åŒ…æ—¶é€»è¾‘å®Œæ•´ï¼‰
          mkdir -p data/configs data/cores data/logs
          # ç»™äºŒè¿›åˆ¶æ–‡ä»¶æ‰§è¡Œæƒé™
          chmod +x SkyNeT-linux-amd64

      # --- 5. è‡ªåŠ¨å‘å¸ƒåˆ° Release ---
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          # æŒ‡å®šè¦ä¸Šä¼ çš„æ–‡ä»¶
          files: |
            SkyNeT-linux-amd64
          # å‘å¸ƒè¯´æ˜
          name: SkyNeT ${{ github.ref_name }}
          body: |
            ## ğŸš€ SkyNeT è‡ªåŠ¨æ„å»ºæˆåŠŸ
            - **ç‰ˆæœ¬**: ${{ github.ref_name }}
            - **åç«¯æ¨¡å—**: `SkyNeT/backend`
            - **æ„å»ºç¯å¢ƒ**: Ubuntu Latest / Go 1.21
            
            ä½¿ç”¨æ–¹æ³•ï¼š
            `chmod +x SkyNeT-linux-amd64 && ./SkyNeT-linux-amd64`
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
