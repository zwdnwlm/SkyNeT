name: SkyNeT Auto Build and Release

on:
  push:
    branches:
      - "main"  # ç›‘å¬ main åˆ†æ”¯çš„æ™®é€š push
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨ç‚¹å‡»è§¦å‘

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write # å¿…é¡»å¼€å¯æƒé™æ‰èƒ½åˆ›å»º/è¦†ç›– Release

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # --- 1. è‡ªåŠ¨ä¿®å¤ä»£ç ä¸­çš„æ—§è·¯å¾„ ---
      - name: Fix Import Paths
        run: |
          echo "Replacing old module paths..."
          # è‡ªåŠ¨å°†æ‰€æœ‰æ–‡ä»¶ä¸­çš„ p-box/backend æ›¿æ¢ä¸º SkyNeT/backend
          grep -rl "p-box/backend" backend/ | xargs sed -i 's|p-box/backend|SkyNeT/backend|g' || echo "No old paths found."

      # --- 2. ç¯å¢ƒå‡†å¤‡ ---
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true
          cache-dependency-path: backend/go.sum

      # --- 3. ç¼–è¯‘åç«¯ ---
      - name: Build Backend
        run: |
          cd backend
          go mod tidy
          BUILD_TIME=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
          # ç¼–è¯‘å½“å‰ç›®å½• (.)
          GOOS=linux GOARCH=amd64 go build \
            -ldflags="-s -w -X 'main.BuildTime=${BUILD_TIME}'" \
            -o ../SkyNeT-linux-amd64 .
          cd ..

      # --- 4. å‘å¸ƒåˆ° Release (è¦†ç›– latest) ---
      - name: Create or Update Release
        uses: [softprops/action-gh-release](https://github.com)@v2
        with:
          # å…³é”®ï¼šå¼ºåˆ¶æŒ‡å®š tag_name ä¸º latestï¼Œç»•è¿‡ "requires a tag" é™åˆ¶
          tag_name: latest
          name: "SkyNeT æŒç»­æ„å»º (Main)"
          body: |
            ## ğŸš€ SkyNeT è‡ªåŠ¨æ„å»ºå‘å¸ƒ
            - **åˆ†æ”¯**: `main`
            - **æ„å»ºæ—¶é—´**: $(date)
            - **è¯´æ˜**: æ­¤ç‰ˆæœ¬ä¸ºè‡ªåŠ¨æ„å»ºçš„æœ€æ–°é¢„è§ˆç‰ˆï¼Œæ¯æ¬¡æ¨é€åˆ° main åˆ†æ”¯éƒ½ä¼šè‡ªåŠ¨æ›´æ–°ã€‚
          files: |
            SkyNeT-linux-amd64
          draft: false
          prerelease: true  # å»ºè®®æ ‡è®°ä¸ºé¢„å‘å¸ƒï¼Œä½œä¸ºå¼€å‘ç‰ˆæœ¬
          make_latest: true # ç¡®ä¿å®ƒæ˜¯é¡µé¢ä¸Šæ˜¾ç¤ºçš„æœ€æ–°ç‰ˆ
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
