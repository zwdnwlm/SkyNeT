name: SkyNeT Build and Release

on:
  push:
    tags:
      - 'v*' # 当你推送以 v 开头的标签（如 v1.0.0）时触发
  workflow_dispatch: # 允许手动触发

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write # 赋予发布 Release 的权限

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # --- 环境初始化 ---
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache-dependency-path: backend/go.sum

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install System Dependencies
        run: sudo apt-get update && sudo apt-get install -y file

      # --- 编译后端 ---
      - name: Build Backend
        run: |
          mkdir -p data/configs data/cores data/logs
          cd backend
          go mod tidy
          # 针对 Linux 编译，去除符号表减小体积
          go build -ldflags="-s -w" -o ../SkyNeT-linux-amd64 .
          cd ..

      # --- 编译前端 ---
      - name: Build Frontend
        run: |
          cd frontend
          npm install
          npm run build --if-present
          cd ..

      # --- 验证运行 ---
      - name: Verify Binary
        run: |
          chmod +x ./SkyNeT-linux-amd64
          file ./SkyNeT-linux-amd64
          # 模拟运行 5 秒后关闭，确保能启动（可选）
          timeout 5s ./SkyNeT-linux-amd64 || echo "Process exited as expected"

      # --- 自动发布 Release ---
      - name: Create Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            SkyNeT-linux-amd64
          name: Release ${{ github.ref_name }}
          body: |
            SkyNeT 自动构建发布
            - Go version: 1.21
            - Node version: 18
          draft: false
          prerelease: false
