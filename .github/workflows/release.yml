name: SkyNeT Multi-Platform Release

on:
  push:
    branches:
      - "main"
  workflow_dispatch:

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # --- 1. è·¯å¾„è‡ªåŠ¨ä¿®å¤ (å¤„ç†æ—§æ¨¡å—å) ---
      - name: Fix Import Paths
        run: |
          grep -rl "p-box/backend" backend/ | xargs sed -i 's|p-box/backend|SkyNeT/backend|g' || echo "No old paths found."

      # --- 2. ç¯å¢ƒå‡†å¤‡ ---
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true
          cache-dependency-path: backend/go.sum

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      # --- 3. ç¼–è¯‘å‰ç«¯ ---
      - name: Build Frontend
        run: |
          cd frontend
          npm install
          npm run build --if-present
          cd ..

      # --- 4. å¤šå¹³å°äº¤å‰ç¼–è¯‘ä¸æ‰“åŒ… ---
      - name: Build and Package
        run: |
          cd backend
          go mod tidy
          BUILD_TIME=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
          LD_FLAGS="-s -w -X 'main.BuildTime=${BUILD_TIME}'"
          
          # å®šä¹‰ç¼–è¯‘ç›®æ ‡åˆ—è¡¨: OS, ARCH, EXTENSION
          # æ ¼å¼: "GOOS GOARCH SUFFIX"
          targets=(
            "linux amd64 .tar.gz"
            "linux arm64 .tar.gz"
            "darwin amd64 .tar.gz"
            "darwin arm64 .tar.gz"
            "windows amd64 .zip"
          )

          for target in "${targets[@]}"; do
            read -r os arch ext <<< "$target"
            echo "Building for $os/$arch..."
            
            BINARY_NAME="SkyNeT"
            [ "$os" == "windows" ] && BINARY_NAME="SkyNeT.exe"
            
            # 1. ç¼–è¯‘
            GOOS=$os GOARCH=$arch go build -ldflags="$LD_FLAGS" -o "../$BINARY_NAME" .
            
            # 2. å‡†å¤‡æ‰“åŒ…ç›®å½•
            cd ..
            mkdir -p data/configs data/cores data/logs
            
            # 3. æ ¹æ®æ ¼å¼æ‰“åŒ…
            PKG_NAME="SkyNeT-$os-$arch$ext"
            if [ "$ext" == ".tar.gz" ]; then
              tar -czvf "$PKG_NAME" "$BINARY_NAME" data/ --warning=no-unknown-keyword
            else
              zip -r "$PKG_NAME" "$BINARY_NAME" data/
            fi
            
            # 4. æ¸…ç†äºŒè¿›åˆ¶æ–‡ä»¶ä»¥ä¾¿ä¸‹æ¬¡ç¼–è¯‘
            rm -f "$BINARY_NAME"
            cd backend
          done

      # --- 5. å‘å¸ƒåˆ° Release (latest) ---
      - name: Create or Update Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: "SkyNeT æŒç»­æ„å»º (Main)"
          body: |
            ## ğŸš€ SkyNeT è·¨å¹³å°å…¨é‡å‘å¸ƒ
            æ­¤ç‰ˆæœ¬ç”± GitHub Actions è‡ªåŠ¨æ„å»ºï¼ŒåŒ…å«æ‰€æœ‰ä¸»æµå¹³å°æ”¯æŒã€‚
            
            ### ğŸ“¥ å¿«é€Ÿå®‰è£…
            ```bash
            curl -fsSL https://raw.githubusercontent.com{{ github.repository }}/main/install.sh | sudo bash
            ```
            
            ### ğŸ“¦ ç¦»çº¿åŒ…åˆ—è¡¨
            - **Linux**: amd64, arm64 (.tar.gz)
            - **Windows**: amd64 (.zip)
            - **macOS**: amd64 (Intel), arm64 (Apple Silicon)
          files: |
            SkyNeT-linux-amd64.tar.gz
            SkyNeT-linux-arm64.tar.gz
            SkyNeT-darwin-amd64.tar.gz
            SkyNeT-darwin-arm64.tar.gz
            SkyNeT-windows-amd64.zip
          draft: false
          prerelease: true
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
