name: SkyNeT Build and Release

on:
  push:
    tags:
      - 'v*' # ä»…åœ¨æ¨é€ v1.0, v2.0.4 ç­‰æ ‡ç­¾æ—¶è§¦å‘

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write # å¿…é¡»æœ‰å†™æƒé™æ‰èƒ½åˆ›å»º Release

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # --- è‡ªåŠ¨ä¿®å¤è·¯å¾„ ---
      - name: Fix Import Paths
        run: |
          grep -rl "p-box/backend" backend/ | xargs sed -i 's|p-box/backend|SkyNeT/backend|g' || echo "No old paths found."

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache-dependency-path: backend/go.sum

      - name: Build Backend
        run: |
          cd backend
          go mod tidy
          BUILD_TIME=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
          GOOS=linux GOARCH=amd64 go build \
            -ldflags="-s -w -X 'main.BuildTime=${BUILD_TIME}'" \
            -o ../SkyNeT-linux-amd64 .
          cd ..

      # --- å‘å¸ƒæ­¥éª¤ ---
      - name: Create GitHub Release
        uses: [softprops/action-gh-release](https://github.com)@v2
        with:
          # è‡ªåŠ¨ä½¿ç”¨ä½ æ¨é€çš„ tag å (å¦‚ v2.0.6)
          tag_name: ${{ github.ref_name }} 
          files: SkyNeT-linux-amd64
          name: SkyNeT ${{ github.ref_name }}
          body: |
            ## ğŸš€ SkyNeT ç”Ÿäº§ç¯å¢ƒç‰ˆæœ¬
            - **ç‰ˆæœ¬å·**: ${{ github.ref_name }}
            - **æ„å»ºæ—¶é—´**: $(date)
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
